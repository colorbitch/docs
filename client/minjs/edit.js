/*! doc 2014-07-09 */
!function(){var a,b;try{a=ace.edit("editor")}catch(c){$.prompt({type:"danger",content:"载入编辑器失败，请刷新页面重试"})}var d={$view:$("#view"),$title:$("#title"),$preview:$("#preview"),converter:new Showdown.converter,toView:function(a){this.$view.html(this.converter.makeHtml(a))},generateFileLink:function(){doc._id&&$(".file-btn").removeClass("hidden").attr("href","/doc/"+doc.user+"/"+doc.title)},save:function(){var b=$(".edit-box").inputBox("data"),c="/post/add/doc";b&&(b.content=a.getValue(),b.auth=$(".auth-btn").hasClass("active")?"private":"public",doc._id&&(b._id=doc._id,c="/post/update/doc"),html2canvas(this.$preview.parent(),{onrendered:function(a){b.thumbnail=a.toDataURL(),$.docsajax({url:c,method:"post",data:b,success:function(a){doc.title=a.doc.title,d.$preview.modal("close"),doc._id||(doc._id=a.doc._id,d.generateFileLink()),$.prompt({type:"success",content:"保存成功"})}})}}))}};a.setTheme("ace/theme/chrome"),a.getSession().setMode("ace/mode/markdown"),a.setAutoScrollEditorIntoView(!0),a.on("change",function(){b&&clearTimeout(b),b=setTimeout(function(){d.toView(a.getValue())},300)}),$(".auth-btn").click(function(){$(this).toggleClass("active")}),$(".view-btn").click(function(){$(this).toggleClass("active"),$(".edit-left,.edit-right").toggleClass("view")}),$(".save-btn").click(function(){var b=$(".edit-box").inputBox("valid");if(!b.length){if(""===a.getValue())return void $.prompt({type:"warning",content:"请输入文档内容"});d.$preview.modal("open"),d.$preview.find(".preview-con").html(d.$view.html())}}),d.$preview.modal({width:900,height:600,title:"预览",button:[{text:"提交",type:"primary",click:function(){d.save()}}]}),d.generateFileLink(),a.setValue($("#content").val())}();