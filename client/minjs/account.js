/*! doc 2014-07-09 */
!function(){var a={$allDocs:$("#all-docs"),$allDecks:$("#all-decks"),$allRepos:$("#all-repos"),$myOrgs:$("#my-orgs"),$joinOrgs:$("#join-orgs"),orgList:[],state:{nowTab:$("#all-docs"),showDetail:function(a,b,c){var d=$(".detail-box");this.nowTab.find("li.active").removeClass("active"),a?(d.find("ul").html(""),d.find(".detail-header").html(c||"设置"),d.removeClass("hidden"),b.addClass("active")):d.addClass("hidden")}},_init:function(){var a=this;url.repos&&$.ajax({url:url.repos,method:"get",success:function(b){a.$allRepos.html(a.reposHtml(b))}}),$.docsajax({url:"/get/user/docs",wrap:a.$allDocs.find("ul"),success:function(b){a.$allDocs.find("ul").html(a.docHtml(b.docs))}}),$.docsajax({url:"/get/user/decks",wrap:a.$allDocs.find("ul"),success:function(b){a.$allDecks.find("ul").html(a.docHtml(b.decks,"slide"))}}),$.docsajax({url:"/get/user/orgs",success:function(b){var c,d=[];c=$.map(b.orgs,function(a){return a.owner!==user?a:void d.push(a)}),a.$myOrgs.find("ul").append(a.myOrgsHtml(d)),a.myOrgList=d,a.$joinOrgs.find("ul").append(a.joinOrgHtml(c)),a.joinOrgList=c}})},docHtml:function(a,b){var b=b||"doc",c="doc"===b?"edit":"deck";return $.map(a,function(a){var d=$("<li>"),e='<a href="/'+b+"/"+a.user+"/"+a.title+'">'+a.title+'</a><div class="pull-right opera-box"><a href="/'+c+"?_id="+a._id+'" data-tip="编辑"><span class="icon-pencil"></span></a><a href="javascript:;" class="del-item" data-tip="删除"><span class="icon-remove"></span></a>'+("public"===a.auth?'<a href="javascript:;" class="private-item" data-tip="取消公开"><span class="icon-lock"></a>':'<a href="javascript:;" class="share-item" data-tip="分享"><span class="icon-share"></a>')+"</div>";return d.html(e).data(b,a)})},shareOrgHtml:function(a){var a=$.map(a,function(a){return a._id});return $.map(this.myOrgList.concat(this.joinOrgList),function(b){var c=$("<li>"),d='<span class="'+($.inArray(""+b._id,a)>=0?"":"icon-checkbox-unchecked")+' icon-checkbox-checked fn-check"></span>'+b.name;return c.html(d).data("org",b)})},reposHtml:function(a){return $.map(a,function(a){return"<li>"+a.name+"</li>"})},myOrgsHtml:function(a){return $.map(a,function(a){var b=$("<li>"),c="<p>组织名称："+a.name+' <a href="javascript:;" class="member-item" data-tip="成员列表"><span class="icon-users"></span></a></p><p>组织代码：'+a.code+"</p><span>组织密码："+a.password+"</span>";return b.html(c).data("org",a)})},joinOrgHtml:function(a){return $.map(a,function(a){var b=$("<li>"),c="<p>组织名称："+a.name+' <a href="javascript:;" class="member-item" data-tip="成员列表"><span class="icon-users"></span></a></p><p>组织代码：'+a.code+"</p><span>组织密码："+a.password+"</span>";return b.html(c).data("org",a)})},joinOrg:function(){var a=this,b=a.$joinOrgs.find(".join-org-box").inputBox("data",{valid:!0,skip:!0});b&&$.docsajax({url:"/post/org/add/user",data:b,method:"post",success:function(b){$.prompt({type:"success",content:"你已成功加入组织"}),a.$joinOrgs.find("ul").append(a.joinOrgHtml([b])),a.$joinOrgs.find(".cancel-btn").click()}})},createOrg:function(){var a=this,b=a.$myOrgs.find(".create-org-box").inputBox("data",{valid:!0,skip:!0});b&&$.docsajax({url:"/post/create/org",data:b,method:"post",success:function(c){$.prompt({type:"success",title:"你已成功创建组织：",content:b.name}),a.$myOrgs.find("ul").append(a.myOrgsHtml([c])),a.$myOrgs.find(".cancel-btn").click()}})},docLinkOrg:function(a,b,c){var d="/post/org/add/doc",a=a;a.link||(d="/post/org/del/doc"),$.docsajax({url:d,data:a,method:"post",wrap:b.closest("li"),cover:!1,loading:"...",success:function(b){$.prompt({type:"success",content:a.link?"你已成功分享文档":"你已成功取消分享文档"}),c&&c(b)}})},privateDoc:function(a,b){var c=a.closest("li").data("deck"===b?"slide":"doc");c={_id:c._id,auth:"private"},$.docsajax({url:"deck"===b?"/post/update/deck":"/post/update/doc",method:"post",data:c,wrap:a.closest("li"),cover:!1,success:function(){$.prompt({type:"success",content:"操作成功"}),a.closest("li").find(".private-item").data("tip","分享").removeClass("private-item").addClass("share-item").find("span").removeClass("icon-lock").addClass("icon-share")}})},membersHtml:function(a){return $.map(a||[],function(a){return'<li><a href="/account/'+a.login+'">'+a.login+"</a></li>"})},getMembers:function(a){var b=this;$.docsajax({url:"/get/org/users",data:{org:a._id},wrap:$(".detail-box"),success:function(a){$(".detail-box ul").html(b.membersHtml(a.members))}})},bindEvent:function(){var a=$(".item-list"),b=$(".slide-tabs li"),c=this;$(".slide-tabs").on("click","li",function(){var d=$(this).index();$(this).hasClass("active")||(a.addClass("hidden").eq(d).removeClass("hidden"),b.removeClass("active").eq(d).addClass("active"),c.state.nowTab=a.eq(d),c.state.showDetail(!1))}),c.$allDocs.on("click",".del-item",function(){var a=$(this).closest("li"),b=a.data("doc");$.msg({type:"danger",msg:"删除的文档将无法恢复，确认删除？",ok:function(){$.docsajax({url:"/post/del/doc",data:b,method:"post",success:function(){a.remove(),$.prompt({type:"success",content:"删除成功"})}})}})}).on("click",".share-item",function(){var a=$(this).closest("li");c.state.showDetail(!0,a,"分享给组织："),$.docsajax({url:"/get/doc/orgs",data:{doc:a.data("doc")._id},wrap:$(".detail-box"),success:function(a){$(".detail-box ul").html(c.shareOrgHtml(a.orgs))}})}).on("click",".private-item",function(){c.privateDoc($(this))}),c.$allDecks.on("click",".del-item",function(){var a=$(this).closest("li"),b=a.data("doc");$.msg({type:"danger",msg:"删除的幻灯片将无法恢复，确认删除？",ok:function(){$.docsajax({url:"/post/del/deck",data:b,method:"post",success:function(){a.remove(),$.prompt({type:"success",content:"删除成功"})}})}})}).on("click",".share-item",function(){var a=$(this).closest("li");c.state.showDetail(!0,a,"分享给组织："),$.docsajax({url:"/get/deck/orgs",data:{doc:a.data("slide")._id},wrap:$(".detail-box"),success:function(a){$(".detail-box ul").html(c.shareOrgHtml(a.orgs))}})}).on("click",".private-item",function(){c.privateDoc($(this),"deck")}),c.$myOrgs.find(".create-org-btn,.cancel-btn").click(function(){c.state.showDetail(!1),c.$myOrgs.find(".create-org-box,.create-org-btn").toggleClass("hidden"),c.$myOrgs.find(".create-org-box").inputBox("clear").inputBox("focus")}),c.$myOrgs.find(".submit-btn").click(function(){c.createOrg()}),c.$joinOrgs.find(".join-org-btn,.cancel-btn").click(function(){c.state.showDetail(!1),c.$joinOrgs.find(".join-org-box,.join-org-btn").toggleClass("hidden"),c.$joinOrgs.find(".join-org-box").inputBox("clear").inputBox("focus")}),c.$joinOrgs.find(".submit-btn").click(function(){c.joinOrg()}),a.on("click",".member-item",function(){var a=$(this).closest("li"),b=a.data("org");c.state.showDetail(!0,a,"成员列表"),c.getMembers(b)}),$(".close-btn").click(function(){c.state.showDetail(!1)}),$(".detail-box").on("click",".fn-check",function(){var a=$(this),b=a.closest("li").data("org")._id,d=c.$allDocs.find("li.active").data("doc")._id,e=a.hasClass("icon-checkbox-unchecked");c.docLinkOrg({org:b,doc:d,link:e},a,function(){a[e?"removeClass":"addClass"]("icon-checkbox-unchecked")})}),c.$myOrgs.find(".create-org-box").inputBox({button:".submit-btn"}),c.$joinOrgs.find(".join-org-box").inputBox({button:".submit-btn"})},init:function(){this._init(),this.bindEvent()}};a.init()}();